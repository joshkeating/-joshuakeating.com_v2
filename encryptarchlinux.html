<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,500" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lora:400,700" rel="stylesheet">	
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
	<title>
		Josh Keating - Encrypting Arch Linux
	</title>
</head>

<body>

	<nav class="navbar">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">Josh Keating</a>
			</div>
			<div class="collapse in" id="myNavbar">
				<ul class="nav navbar-nav navbar-right">
					<li><a href="about.html">About</a></li>
					<li><a href="resources/resume/Resume.pdf">Resume</a></li>
					<li><a href="https://github.com/joshkeating">Github</a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div class="container-fluid text-center">
		<div class="row content">
			<div class="col-sm-2 sidenav">
				<!-- Leave this as a blank sidebar -->
			</div>
			<div class="col-sm-8">

			<article>
				<header>
					<div class="article-header">
						<h2 class="article-title">
							Encrypting Arch Linux
						</h2>
						<p class="article-date">
							January 20th, 2017
						</p>
					</div>
				</header>

				<div class="article-content">
					<p>
                        After deciding to say sayōnara to my previous dual booted system (Windows and Arch) and go 100% Arch, I came to the realization that this would be a great time to be proactive in securing my data and do some full disk encryption.  This will be a brief guide on installing Arch Linux on a new system using <a class="about_links" href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system">LUKS</a> for full-disk encryption and <a class="about_links" href="https://wiki.archlinux.org/index.php/LVM">LVM</a> for volume management. My motivations for writing this guide are not entirely altruistic - this is documentation for future me as much as it is a guide for anyone who stumbles upon this article.
					</p>
					<h4 class="article-subheading">
						The Setup
					</h4>
					<p>
                        You'll need a bootable flash drive loaded with a current version of of the ISO image.  If you’re on Windows it’s also a good idea to disable Secure Boot with UEFI enabled.  I will also assume that you are using a SATA based hard drive, in the case that your drive is NVMe based keep in mind that the partition naming scheme will differ i.e. <code class="inlinecode">/dev/nmve0</code> vs <code class="inlinecode">/dev/sda</code>.
					</p>
					<h4 class="article-subheading">
						Partitioning
					</h4>
					<p>
						First we are going to zero out the disk, this is done to ensure that the disk is properly wiped and prepared for encryption.  We zero-fill the disk by writing a zero byte to every addressable location on the disk using the /dev/zero stream.

												<pre class="codeblock">
$ cryptsetup open --type plain /dev/sdXY container --key-file /dev/random
$ dd if=/dev/zero of=/dev/mapper/container status=progress</pre>

						We're going to use the GPT partition scheme since we’re on a UEFI system. 

						<pre class="codeblock">
$ gdisk /dev/sda</pre>
						
						Then we'll set up the ESP and root partitions. There are a number of partitioning tools that you can use, here I will use fdisk. The ESP partition should have a size of 512M and use the partition table type of EFI System  (EFI System in fdisk or EF00 in gdisk) . We can fill the rest of the space with the root partition.

						<pre class="codeblock">
$ fdisk /dev/sda
$ mkfs.fat -F32 -nESP /dev/sda1
$ mkfs.ext4 /dev/sda2</pre>

					</p>
					<h4 class="article-subheading">
						LUKS disk encryption
					</h4>
					<p>
						I use LUKS or Linux Unified Key Setup to encrypt my drive for two main reasons, further partitioning is super easy with LVM and it allows for single key authentication to unlock all volumes.  The only caveat to this setup in the vulnerability of the bootloader. Though there are steps you can take to secure your boot I will not be covering them here.

						<pre class="codeblock">
$ cryptsetup luksFormat /dev/sda2
$ cryptsetup open --type luks /dev/sda2 lvm</pre>
					</p>
					<h4 class="article-subheading">
						LVM filesystem management
					</h4>
					<p>
						Logical Volume Management uses the kernel's device-mapper feature to create "virtual partitions" that make expanding or shrinking partitions ridiculously easy. LVM also supports snapshots which are an efficient way perform backups. I prefer to keep my partition scheme relatively simple with just root, home, and swap partitions. You can call your physical volume whatever you like, here I call it VirtVol.

						<pre class="codeblock">
$ pvcreate /dev/mapper/lvm
$ vgcreate VirtVol /dev/mapper/lvm

$ lvcreate -L 40G VirtVol -n root
$ lvcreate -L 8G VirtVol -n swap
$ lvcreate -l 100%FREE VirtVol -n home

$ mkfs.ext4 /dev/mapper/VirtVol-root
$ mkfs.ext4 /dev/mapper/VirtVol-home
$ mkswap /dev/mapper

$ mount /dev/mapper/VirtVol-root /mnt
$ mkdir /mnt/home
$ mount /dev/mapper/VirtVol-home /mnt/home
$ swapon /dev/mapper/VirtVol-swap
</pre>
					</p>
					<h4 class="article-subheading">
						Arch Install
					</h4>
					<p>
						With the parations all setup now we can install the base system.  First we’re going to mount the boot partition and then install the base packages.

						<pre class="codeblock">
$ mkdir /mnt/boot
$ mount /dev/sda1 /mnt/boot

$ pacstrap /mnt base base-devel</pre>

						Now we generate our filesystem information, and chroot into our new installation.

						<pre class="codeblock">
$ genfstab -U /mnt >> /mnt/etc/fstab
$ arch-chroot /mnt /bin/bash</pre>

						Next we're going to want uncomment <code class="inlinecode">en_US.UTF-8</code> to set up UTF-8 character encoding. We also want to generate and create the locale.

						<pre class="codeblock">
$ vim /etc/locale.gen
$ locale-gen
$ cat >>/etc/locale.conf
> LANG=en_US.UTF-8</pre>

						Next set up your timezone and sync the hardware clock

						<pre class="codeblock">
$ ln -s /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
$ hwclock --systohc --utc</pre>

						Finally we need to configure and generate a new initial ramdisk environment. Remember to take special care to set <code class="inlinecode">encrypt</code> and <code class="inlinecode">lvm</code> to be in front of <code class="inlinecode">filesystem</code> in <code class="inlinecode">HOOKS=”..”</code>.

						<pre class="codeblock">
$ vim /etc/mkinitcpio.conf
$ mkinitcpio -p linux</pre>

						Here's a look at what my partition scheme looks like.
						<br>
						<br>
						<img class="img-responsive" src="resources/images/lsblk-encrypt.png" alt="partition scheme">
					</p>

					



					<h4 class="article-subheading">
						systemd-boot
					</h4>
					<p>
						The last thing we need to do is set up our boot manager.  I use systemd-boot which works on UEFI systems and is easy to set up.  We first need to make sure that the ESP partition is mounted at <code class="inlinecode">/boot</code>. Then install systemd-boot.

						<pre class="codeblock">
$ mount -l | grep boot
$ bootctl install</pre>

						Next we need the UUID of our root partition.

						<pre class="codeblock">
$ blkid -s UUID -o value /dev/sda2</pre>

						Finally we need to write a boot entry. If you have an intel processor it's a good idea to include initrd /intel-ucode.img in your boot entry, this enables microcode updates for the stability and security of the processor. You will need to install the intel-ucode package through pacman before this will work however. 

						<pre class="codeblock">
$ cat >>arch-encrypted-lvm.conf
title Encrypted Arch Linux
linux /vmlinuz-linux
initrd /intel-ucode.img
initrd /initramfs-linux.img
options cryptdevice=UUID=(UUID goes here):VirtVol root=/dev/mapper/VirtVol-root quiet rw</pre>
					</p>

					Alright that's it! Now you can <code class="inlinecode">exit</code>, reboot, and if you did everything right be greeted with a login shell.
					<br>
					<br>
					In my next post I'll probably do a writeup about setting up Arch in a usable configuration. 

				</div>

			</article>

			</div>
			<div class="col-sm-2 sidenav">
				<!-- Leave this as a blank sidebar -->
			</div>
		</div>


	</div>

	<footer class="footer">
            <p class="footer_text">© 2017 Joshua Keating. All rights reserved.</p>
    </footer>

</body>

</html>